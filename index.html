<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transactions Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f0f0f; color: #e0e0e0; min-height: 100vh; }
    .header { background: #1a1a1a; border-bottom: 1px solid #2a2a2a; padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 10; }
    .header h1 { font-size: 18px; font-weight: 600; color: #fff; }

    /* Filters */
    .filters { background: #1a1a1a; border-bottom: 1px solid #2a2a2a; padding: 10px 24px; display: flex; align-items: center; justify-content: space-between; gap: 8px; position: sticky; top: 57px; z-index: 9; }
    .filters-left { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .filter-btn { padding: 6px 14px; border-radius: 20px; border: 1px solid #333; background: transparent; color: #aaa; font-size: 13px; cursor: pointer; transition: all 0.15s; }
    .filter-btn:hover { border-color: #555; color: #ddd; }
    .filter-btn.active { background: #fff; color: #000; border-color: #fff; font-weight: 500; }

    /* Live / History toggle */
    .view-toggle { display: flex; background: #111; border: 1px solid #2a2a2a; border-radius: 8px; overflow: hidden; flex-shrink: 0; }
    .toggle-btn { padding: 6px 14px; font-size: 12px; font-weight: 500; cursor: pointer; border: none; background: transparent; color: #555; transition: all 0.2s; white-space: nowrap; }
    .toggle-btn.live-active { background: #1a2e1a; color: #4ade80; }
    .toggle-btn.history-active { background: #1e1e2e; color: #818cf8; }

    /* Cards */
    .container { max-width: 900px; margin: 0 auto; padding: 16px; }
    .tx-card { background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 10px; padding: 14px 18px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; transition: background 0.15s; }
    .tx-card:hover { background: #222; }
    .tx-left { display: flex; align-items: center; gap: 14px; }
    .tx-icon { width: 38px; height: 38px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 700; flex-shrink: 0; overflow: hidden; background: #2a2a2a; color: #aaa; }
    .tx-icon img { width: 100%; height: 100%; object-fit: cover; border-radius: 10px; }
    .tx-info h3 { font-size: 14px; font-weight: 500; color: #fff; margin-bottom: 3px; }
    .tx-info p { font-size: 12px; color: #777; }
    .tx-right { text-align: right; }
    .tx-price { font-size: 16px; font-weight: 600; color: #4ade80; }
    .tx-time { font-size: 11px; color: #666; margin-top: 2px; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; margin-left: 6px; }
    .badge.new_subscription { background: #1a3a2a; color: #4ade80; }
    .badge.trial_to_paid { background: #1a2a3a; color: #60a5fa; }
    .badge.one_time_purchase { background: #3a2a1a; color: #fbbf24; }

    /* Day group headers */
    .day-header { display: flex; align-items: baseline; justify-content: space-between; padding: 20px 0 8px; }
    .day-header:first-child { padding-top: 4px; }
    .day-label { font-size: 13px; font-weight: 600; color: #aaa; }
    .day-summary { font-size: 13px; font-weight: 600; color: #fff; }

    .show-more { display: block; width: 100%; padding: 14px; margin: 16px 0; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 10px; color: #aaa; font-size: 14px; cursor: pointer; transition: all 0.15s; }
    .show-more:hover { background: #222; color: #fff; }
    .empty-state { text-align: center; padding: 80px 20px; color: #555; }
    .empty-state h2 { font-size: 18px; margin-bottom: 8px; color: #777; }
    .empty-state p { font-size: 14px; }
    .loading { text-align: center; padding: 40px; color: #555; }
    .live-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #4ade80; margin-right: 6px; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .country-flag { margin-left: 4px; }
  </style>
</head>
<body>
  <div class="header">
    <h1><span class="live-dot"></span> Transactions Dashboard</h1>
  </div>

  <div class="filters">
    <div class="filters-left" id="filters">
      <button class="filter-btn active" data-app="all">All Apps</button>
    </div>
    <div class="view-toggle">
      <button class="toggle-btn live-active" id="toggleLive" onclick="setViewMode('live')">‚óè Live</button>
      <button class="toggle-btn" id="toggleHistory" onclick="setViewMode('history')">History</button>
    </div>
  </div>

  <div class="container" id="container">
    <div class="loading">Loading transactions...</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, query, orderBy, limit, startAfter, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCnfHM5rp-p1wuEMN2BPE4koLrp9WqcQ_c",
      authDomain: "tangent-transactions-dashboard.firebaseapp.com",
      projectId: "tangent-transactions-dashboard",
      storageBucket: "tangent-transactions-dashboard.firebasestorage.app",
      messagingSenderId: "890857087611",
      appId: "1:890857087611:web:b871ac1b87fc7e1107f8de"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const SNAPSHOT_SIZE = 100;
    const PAGE_SIZE = 30;
    let lastDoc = null;
    let currentApp = "all";
    let viewMode = "live";
    let allTxs = [];
    let knownApps = new Set();

    window.setViewMode = function(mode) {
      viewMode = mode;
      document.getElementById("toggleLive").className = "toggle-btn" + (mode === "live" ? " live-active" : "");
      document.getElementById("toggleHistory").className = "toggle-btn" + (mode === "history" ? " history-active" : "");
      renderAll();
    };

    const appIcons = {
      "GirlTalk": "https://is1-ssl.mzstatic.com/image/thumb/Purple221/v4/ee/4b/ed/ee4bed9a-e8fa-26fe-5e3e-d27499ccee2e/AppIcon-0-0-1x_U007emarketing-0-11-0-85-220.png/100x100bb.jpg",
      "GirlWalk": "https://is1-ssl.mzstatic.com/image/thumb/Purple211/v4/9d/4b/4a/9d4b4a51-f774-99f3-0709-a5738b888667/AppIcon-0-0-1x_U007emarketing-0-8-0-0-85-220.png/100x100bb.jpg",
      "Christian Daily Task": "https://is1-ssl.mzstatic.com/image/thumb/Purple211/v4/f1/f8/a3/f1f8a327-c6ee-7e92-2660-8fd9014eb973/AppIcon-0-0-1x_U007emarketing-0-8-0-85-220.png/100x100bb.jpg",
      "Spicy Stories": "https://is1-ssl.mzstatic.com/image/thumb/Purple221/v4/b9/a4/f1/b9a4f18f-f6ac-3517-36c8-d52226fadcbe/AppIcon-0-0-1x_U007emarketing-0-11-0-85-220.png/100x100bb.jpg",
      "Christian Music": "https://is1-ssl.mzstatic.com/image/thumb/Purple211/v4/da/7b/95/da7b952c-8a66-f93c-bdc6-9002ddd99984/AppIcon-0-0-1x_U007emarketing-0-9-0-85-220.png/100x100bb.jpg",
      "Poly AI": "https://is1-ssl.mzstatic.com/image/thumb/Purple211/v4/80/5a/3b/805a3b7c-0c7e-b270-cdda-1cc8d17c500c/AppIcon-0-0-1x_U007emarketing-0-11-0-85-220.png/100x100bb.jpg",
      "Hola": "https://is1-ssl.mzstatic.com/image/thumb/Purple211/v4/ab/8e/01/ab8e0122-f693-96a2-5677-06a38b6e2c9b/AppIcon-0-0-1x_U007epad-0-1-0-85-220.jpeg/100x100bb.jpg",
      "Better Stretch": "https://is1-ssl.mzstatic.com/image/thumb/Purple211/v4/8d/e6/90/8de69039-0ff2-2293-4ca0-4f35aab11e5c/AppIcon-0-0-1x_U007ephone-0-1-0-85-220.jpeg/100x100bb.jpg",
      "Murder Mystery": "https://is1-ssl.mzstatic.com/image/thumb/Purple211/v4/a7/da/4e/a7da4e20-af84-395e-ad5e-00b75c214106/AppIcon-0-0-1x_U007ephone-0-1-0-85-220.png/100x100bb.jpg",
      "Crime Novels": "https://is1-ssl.mzstatic.com/image/thumb/Purple221/v4/ea/ec/30/eaec30fe-9e26-0179-1f70-61c6f57e34e2/AppIcon-1x_U007epad-0-1-85-220-0.png/100x100bb.jpg",
      "Daily Prayers": "https://is1-ssl.mzstatic.com/image/thumb/Purple221/v4/8b/00/59/8b005995-708f-d0a7-024a-bc033e23943b/AppIcon-0-0-1x_U007emarketing-0-11-0-85-220.png/100x100bb.jpg",
      "Prayer": "https://is1-ssl.mzstatic.com/image/thumb/Purple211/v4/0a/a1/9b/0aa19bf7-0cce-37d9-f578-a3376f3108a6/AppIcon-0-0-1x_U007emarketing-0-11-0-85-220.png/100x100bb.jpg",
      "Reel Short Stories": "https://is1-ssl.mzstatic.com/image/thumb/Purple211/v4/19/32/a8/1932a840-902d-4337-cda8-b102c558c66c/AppIcon-0-0-1x_U007emarketing-0-11-0-85-220.png/100x100bb.jpg",
      "Girls Therapy": "https://is1-ssl.mzstatic.com/image/thumb/Purple211/v4/78/cf/84/78cf845e-28ba-f41b-1261-8b85332373c0/AppIcon-0-0-1x_U007emarketing-0-11-0-0-85-220.png/100x100bb.jpg"
    };

    const labels = { new_subscription: "Direct Subscription", trial_to_paid: "Trial \u2192 Paid", one_time_purchase: "One-Time Purchase" };

    function timeAgo(date) {
      const now = new Date(); const diff = (now - date) / 1000;
      if (diff < 60) return Math.floor(diff) + "s ago";
      if (diff < 3600) return Math.floor(diff / 60) + "m ago";
      if (diff < 86400) return Math.floor(diff / 3600) + "h ago";
      if (diff < 604800) return Math.floor(diff / 86400) + "d ago";
      return date.toLocaleDateString("en-US", { month: "short", day: "numeric" });
    }
    function formatExactTime(date) {
      return date.toLocaleDateString("en-US", { month: "short", day: "numeric", hour: "2-digit", minute: "2-digit", hour12: false });
    }
    function formatCurrency(price, currency) {
      try { return new Intl.NumberFormat("en-US", { style: "currency", currency: currency || "USD", minimumFractionDigits: 2 }).format(price); }
      catch { return "$" + Number(price).toFixed(2); }
    }
    function countryToFlag(code) {
      if (!code || code.length !== 2) return "";
      const codePoints = code.toUpperCase().split("").map(c => 127397 + c.charCodeAt(0));
      return String.fromCodePoint(...codePoints);
    }
    function getTxDate(tx) {
      return tx.received_at?.toDate ? tx.received_at.toDate() : new Date(tx.event_timestamp_ms || 0);
    }
    function getDayKey(date) {
      const d = new Date(date); d.setHours(0, 0, 0, 0); return d.getTime();
    }
    function getDayLabel(ts) {
      const today = new Date(); today.setHours(0, 0, 0, 0);
      const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
      if (ts === today.getTime()) return "Today";
      if (ts === yesterday.getTime()) return "Yesterday";
      return new Date(ts).toLocaleDateString("en-US", { weekday: "long", month: "short", day: "numeric" });
    }
    function renderDayHeader(label, txs) {
      const rev = txs.reduce((s, t) => s + (t.price || 0), 0);
      const count = txs.length + " conversion" + (txs.length !== 1 ? "s" : "");
      return '<div class="day-header"><span class="day-label">' + label + '</span><span class="day-summary">' + formatCurrency(rev, "USD") + ' \u00b7 ' + count + '</span></div>';
    }

    function renderTx(tx) {
      const type = tx.transaction_type || "unknown";
      const label = labels[type] || type;
      const ts = getTxDate(tx);
      const flag = countryToFlag(tx.country_code);
      const appName = tx.app_name || "Unknown";
      const iconUrl = appIcons[appName];
      const iconHtml = iconUrl
        ? '<img src="' + iconUrl + '" alt="' + appName + '" />'
        : appName.charAt(0);
      return '<div class="tx-card"><div class="tx-left"><div class="tx-icon">' + iconHtml + '</div><div class="tx-info"><h3>' + appName + ' <span class="badge ' + type + '">' + label + '</span></h3><p>' + (tx.product_id || "\u2014") + (flag ? ' <span class="country-flag">' + flag + '</span>' : "") + ' \u00b7 ' + (tx.store || "") + '</p></div></div><div class="tx-right"><div class="tx-price">' + formatCurrency(tx.price, tx.currency) + '</div><div class="tx-time">' + formatExactTime(ts) + ' \u00b7 ' + timeAgo(ts) + '</div></div></div>';
    }

    function getFilteredTxs() {
      const today = new Date(); today.setHours(0, 0, 0, 0);
      let txs = currentApp === "all" ? allTxs : allTxs.filter(t => t.app_name === currentApp);
      if (viewMode === "live") txs = txs.filter(t => getTxDate(t) >= today);
      return txs;
    }

    function renderAll() {
      const container = document.getElementById("container");
      const filtered = getFilteredTxs();

      if (filtered.length === 0) {
        const msg = viewMode === "live"
          ? '<div class="empty-state"><h2>No transactions today</h2><p>Switch to History to see past transactions.</p></div>'
          : '<div class="empty-state"><h2>No transactions yet</h2><p>Transactions will appear here as they come in from RevenueCat.</p></div>';
        container.innerHTML = msg;
        return;
      }

      if (viewMode === "history") {
        const groups = {};
        const groupOrder = [];
        filtered.forEach(tx => {
          const key = getDayKey(getTxDate(tx));
          if (!groups[key]) { groups[key] = []; groupOrder.push(key); }
          groups[key].push(tx);
        });
        let html = "";
        groupOrder.forEach(key => {
          html += renderDayHeader(getDayLabel(key), groups[key]);
          html += groups[key].map(renderTx).join("");
        });
        if (lastDoc && allTxs.length >= PAGE_SIZE) {
          html += '<button class="show-more" id="loadMore">Show more</button>';
        }
        container.innerHTML = html;
        const btn = document.getElementById("loadMore");
        if (btn) btn.addEventListener("click", loadMore);
      } else {
        // Live mode: show "Today" header with running total, then cards
        let html = renderDayHeader("Today", filtered);
        html += filtered.map(renderTx).join("");
        container.innerHTML = html;
      }
    }

    function updateFilters() {
      allTxs.forEach(t => { if (t.app_name) knownApps.add(t.app_name); });
      const filtersEl = document.getElementById("filters");
      const apps = Array.from(knownApps).sort();
      filtersEl.innerHTML = '<button class="filter-btn ' + (currentApp === "all" ? "active" : "") + '" data-app="all">All Apps</button>' +
        apps.map(a => '<button class="filter-btn ' + (currentApp === a ? "active" : "") + '" data-app="' + a + '">' + a + '</button>').join("");
      filtersEl.querySelectorAll(".filter-btn").forEach(btn => {
        btn.addEventListener("click", () => { currentApp = btn.dataset.app; updateFilters(); renderAll(); });
      });
    }

    async function loadMore() {
      if (!lastDoc) return;
      const q = query(collection(db, "transactions"), orderBy("received_at", "desc"), startAfter(lastDoc), limit(PAGE_SIZE));
      const snap = await getDocs(q);
      if (snap.empty) { lastDoc = null; renderAll(); return; }
      snap.forEach(doc => allTxs.push(doc.data()));
      lastDoc = snap.docs[snap.docs.length - 1];
      updateFilters(); renderAll();
    }

    function startListening() {
      const q = query(collection(db, "transactions"), orderBy("received_at", "desc"), limit(SNAPSHOT_SIZE));
      onSnapshot(q, (snapshot) => {
        allTxs = [];
        snapshot.forEach(doc => allTxs.push(doc.data()));
        lastDoc = snapshot.docs.length > 0 ? snapshot.docs[snapshot.docs.length - 1] : null;
        updateFilters(); renderAll();
      }, (err) => {
        console.error("Firestore error:", err);
        document.getElementById("container").innerHTML = '<div class="empty-state"><h2>Connection error</h2><p>' + err.message + '</p></div>';
      });
    }

    startListening();
  </script>
</body>
</html>
