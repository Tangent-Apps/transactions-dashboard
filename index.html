<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transactions Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f0f0f; color: #e0e0e0; min-height: 100vh; }
    .header { background: #1a1a1a; border-bottom: 1px solid #2a2a2a; padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 10; }
    .header h1 { font-size: 20px; font-weight: 600; color: #fff; }
    .header .stats { font-size: 13px; color: #888; }
    .filters { background: #1a1a1a; border-bottom: 1px solid #2a2a2a; padding: 12px 24px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .filter-btn { padding: 6px 14px; border-radius: 20px; border: 1px solid #333; background: transparent; color: #aaa; font-size: 13px; cursor: pointer; transition: all 0.15s; }
    .filter-btn:hover { border-color: #555; color: #ddd; }
    .filter-btn.active { background: #fff; color: #000; border-color: #fff; font-weight: 500; }
    .container { max-width: 900px; margin: 0 auto; padding: 16px; }
    .tx-card { background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 10px; padding: 14px 18px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; transition: background 0.15s; }
    .tx-card:hover { background: #222; }
    .tx-left { display: flex; align-items: center; gap: 14px; }
    .tx-icon { width: 38px; height: 38px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
    .tx-icon.new_subscription { background: #1a3a2a; }
    .tx-icon.trial_to_paid { background: #1a2a3a; }
    .tx-icon.one_time_purchase { background: #3a2a1a; }
    .tx-info h3 { font-size: 14px; font-weight: 500; color: #fff; margin-bottom: 3px; }
    .tx-info p { font-size: 12px; color: #777; }
    .tx-right { text-align: right; }
    .tx-price { font-size: 16px; font-weight: 600; color: #4ade80; }
    .tx-time { font-size: 11px; color: #666; margin-top: 2px; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; margin-left: 6px; }
    .badge.new_subscription { background: #1a3a2a; color: #4ade80; }
    .badge.trial_to_paid { background: #1a2a3a; color: #60a5fa; }
    .badge.one_time_purchase { background: #3a2a1a; color: #fbbf24; }
    .show-more { display: block; width: 100%; padding: 14px; margin: 16px 0; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 10px; color: #aaa; font-size: 14px; cursor: pointer; transition: all 0.15s; }
    .show-more:hover { background: #222; color: #fff; }
    .empty-state { text-align: center; padding: 80px 20px; color: #555; }
    .empty-state h2 { font-size: 18px; margin-bottom: 8px; color: #777; }
    .empty-state p { font-size: 14px; }
    .loading { text-align: center; padding: 40px; color: #555; }
    .live-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #4ade80; margin-right: 6px; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .country-flag { margin-left: 4px; }
  </style>
</head>
<body>
  <div class="header">
    <h1><span class="live-dot"></span> Transactions Dashboard</h1>
    <div class="stats" id="stats">Loading...</div>
  </div>
  <div class="filters" id="filters">
    <button class="filter-btn active" data-app="all">All Apps</button>
  </div>
  <div class="container" id="container">
    <div class="loading">Loading transactions...</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, query, orderBy, limit, startAfter, getDocs, onSnapshot, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCnfHM5rp-p1wuEMN2BPE4koLrp9WqcQ_c",
      authDomain: "tangent-transactions-dashboard.firebaseapp.com",
      projectId: "tangent-transactions-dashboard",
      storageBucket: "tangent-transactions-dashboard.firebasestorage.app",
      messagingSenderId: "890857087611",
      appId: "1:890857087611:web:b871ac1b87fc7e1107f8de"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const PAGE_SIZE = 30;
    let lastDoc = null;
    let currentApp = "all";
    let allTxs = [];
    let knownApps = new Set();
    let unsubscribe = null;
    const icons = { new_subscription: "\u{1F4B3}", trial_to_paid: "\u2705", one_time_purchase: "\u{1F6D2}" };
    const labels = { new_subscription: "New Subscription", trial_to_paid: "Trial \u2192 Paid", one_time_purchase: "One-Time Purchase" };
    function timeAgo(date) {
      const now = new Date(); const diff = (now - date) / 1000;
      if (diff < 60) return Math.floor(diff) + "s ago";
      if (diff < 3600) return Math.floor(diff / 60) + "m ago";
      if (diff < 86400) return Math.floor(diff / 3600) + "h ago";
      if (diff < 604800) return Math.floor(diff / 86400) + "d ago";
      return date.toLocaleDateString("en-US", { month: "short", day: "numeric" });
    }
    function formatCurrency(price, currency) {
      try { return new Intl.NumberFormat("en-US", { style: "currency", currency: currency || "USD", minimumFractionDigits: 2 }).format(price); }
      catch { return "$" + Number(price).toFixed(2); }
    }
    function countryToFlag(code) {
      if (!code || code.length !== 2) return "";
      const codePoints = code.toUpperCase().split("").map(c => 127397 + c.charCodeAt(0));
      return String.fromCodePoint(...codePoints);
    }
    function renderTx(tx) {
      const type = tx.transaction_type || "unknown";
      const icon = icons[type] || "\u{1F4E6}";
      const label = labels[type] || type;
      const ts = tx.received_at?.toDate ? tx.received_at.toDate() : new Date(tx.event_timestamp_ms || Date.now());
      const flag = countryToFlag(tx.country_code);
      return '<div class="tx-card"><div class="tx-left"><div class="tx-icon ' + type + '">' + icon + '</div><div class="tx-info"><h3>' + (tx.app_name || "Unknown") + ' <span class="badge ' + type + '">' + label + '</span></h3><p>' + (tx.product_id || "\u2014") + (flag ? ' <span class="country-flag">' + flag + '</span>' : "") + ' \u00b7 ' + (tx.store || "") + '</p></div></div><div class="tx-right"><div class="tx-price">' + formatCurrency(tx.price, tx.currency) + '</div><div class="tx-time">' + timeAgo(ts) + '</div></div></div>';
    }
    function renderAll() {
      const container = document.getElementById("container");
      const filtered = currentApp === "all" ? allTxs : allTxs.filter(t => t.app_name === currentApp);
      if (filtered.length === 0) { container.innerHTML = '<div class="empty-state"><h2>No transactions yet</h2><p>Transactions will appear here as they come in from RevenueCat.</p></div>'; return; }
      container.innerHTML = filtered.map(renderTx).join("");
      if (lastDoc && filtered.length >= PAGE_SIZE) { container.innerHTML += '<button class="show-more" id="loadMore">Show more</button>'; document.getElementById("loadMore").addEventListener("click", loadMore); }
    }
    function updateStats() {
      const today = new Date(); today.setHours(0, 0, 0, 0);
      const todayTxs = allTxs.filter(t => { const ts = t.received_at?.toDate ? t.received_at.toDate() : new Date(t.event_timestamp_ms || 0); return ts >= today; });
      const todayRevenue = todayTxs.reduce((sum, t) => sum + (t.price || 0), 0);
      document.getElementById("stats").innerHTML = "Today: " + todayTxs.length + " transactions \u00b7 " + formatCurrency(todayRevenue, "USD");
    }
    function updateFilters() {
      allTxs.forEach(t => { if (t.app_name) knownApps.add(t.app_name); });
      const filtersEl = document.getElementById("filters");
      const apps = Array.from(knownApps).sort();
      filtersEl.innerHTML = '<button class="filter-btn ' + (currentApp === "all" ? "active" : "") + '" data-app="all">All Apps</button>' + apps.map(a => '<button class="filter-btn ' + (currentApp === a ? "active" : "") + '" data-app="' + a + '">' + a + '</button>').join("");
      filtersEl.querySelectorAll(".filter-btn").forEach(btn => { btn.addEventListener("click", () => { currentApp = btn.dataset.app; renderAll(); updateFilters(); }); });
    }
    async function loadMore() {
      if (!lastDoc) return;
      let q = query(collection(db, "transactions"), orderBy("received_at", "desc"), startAfter(lastDoc), limit(PAGE_SIZE));
      const snap = await getDocs(q);
      if (snap.empty) { lastDoc = null; renderAll(); return; }
      snap.forEach(doc => allTxs.push(doc.data()));
      lastDoc = snap.docs[snap.docs.length - 1];
      updateStats(); updateFilters(); renderAll();
    }
    function startListening() {
      const q = query(collection(db, "transactions"), orderBy("received_at", "desc"), limit(PAGE_SIZE));
      unsubscribe = onSnapshot(q, (snapshot) => {
        allTxs = [];
        snapshot.forEach(doc => allTxs.push(doc.data()));
        lastDoc = snapshot.docs.length > 0 ? snapshot.docs[snapshot.docs.length - 1] : null;
        updateStats(); updateFilters(); renderAll();
      }, (err) => {
        console.error("Firestore error:", err);
        document.getElementById("container").innerHTML = '<div class="empty-state"><h2>Connection error</h2><p>' + err.message + '</p></div>';
      });
    }
    startListening();
  </script>
</body>
</html>
